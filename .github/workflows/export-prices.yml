name: export-prices

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Price download start date (YYYY-MM-DD)"
        required: true
        default: "2000-01-01"
      universe_config:
        description: "Universe config YAML path (NOT in .github/workflows)"
        required: true
        default: "config/universe_round10.yml"
      out_path:
        description: "Output prices csv path"
        required: true
        default: "data/prices.csv"

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install package + deps
        run: |
          python -m pip install --upgrade pip
          pip install .
          pip install pyyaml

      - name: Download prices (yfinance)
        run: |
          mkdir -p "$(dirname "${{ inputs.out_path }}")"
          python scripts/download_prices.py \
            --start "${{ inputs.start_date }}" \
            --out "${{ inputs.out_path }}" \
            --tickers-from-config "${{ inputs.universe_config }}"

      - name: Sanity check
        run: |
          echo "== file =="
          ls -la "${{ inputs.out_path }}"
          echo "== head =="
          head -n 5 "${{ inputs.out_path }}" || true
          echo "== tail =="
          tail -n 5 "${{ inputs.out_path }}" || true

      - name: Upload prices artifact
        uses: actions/upload-artifact@v4
        with:
          name: prices_csv
          path: ${{ inputs.out_path }}