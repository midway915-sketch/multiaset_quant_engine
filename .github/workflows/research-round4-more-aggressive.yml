name: research-round4-more-aggressive

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          # for parquet -> csv conversion
          pip install pyarrow

      - name: Download prices (Yahoo)
        run: |
          python scripts/download_prices.py \
            --start 2000-01-01 \
            --tickers-from-config config/universe.yml \
            --out data/prices.csv

      - name: Run Round4 aggressive grid
        run: |
          python scripts/run_grid.py \
            --prices data/prices.csv \
            --config config/universe.yml \
            --grid config/grid_round4_more_aggressive.yml \
            --out-dir out_grid_round4

      - name: Convert wf_results parquet to csv (if exists)
        run: |
          python - << 'PY'
          from pathlib import Path
          import pandas as pd

          out_dir = Path("out_grid_round4")
          pq = out_dir / "wf_results.parquet"
          csv = out_dir / "wf_results.csv"

          if pq.exists():
              df = pd.read_parquet(pq)
              df.to_csv(csv, index=False)
              print(f"saved {csv} ({len(df):,} rows)")
          else:
              print("wf_results.parquet not found; skipping conversion")
          PY

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: round4-more-aggressive-results
          path: |
            config/grid_round4_more_aggressive.yml
            out_grid_round4/param_summary.csv
            out_grid_round4/best_params.json
            out_grid_round4/wf_results.csv
            out_grid_round4/wf_results.parquet