name: research-round9-weekly-hybrid-expanded

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pyarrow

      - name: Download prices (Yahoo)
        run: |
          python scripts/download_prices.py \
            --start 2000-01-01 \
            --tickers-from-config config/universe.yml \
            --out data/prices.csv

      - name: Run Round9 weekly hybrid expanded universe grid
        run: |
          python scripts/run_grid.py \
            --prices data/prices.csv \
            --config config/universe.yml \
            --grid config/grid_round9_weekly_hybrid_expanded.yml \
            --out-dir out_grid_round9_weekly_hybrid

      - name: Convert wf_results parquet to csv (if exists)
        run: |
          python - << 'PY'
          from pathlib import Path
          import pandas as pd

          out_dir = Path("out_grid_round9_weekly_hybrid")
          pq = out_dir / "wf_results.parquet"
          csv = out_dir / "wf_results.csv"

          if pq.exists():
              df = pd.read_parquet(pq)
              df.to_csv(csv, index=False)
              print(f"saved {csv} ({len(df):,} rows)")
          else:
              print("wf_results.parquet not found; skipping conversion")
          PY

      - name: Export best full-period equity
        run: |
          python scripts/export_best_equity.py \
            --prices data/prices.csv \
            --config config/universe.yml \
            --best-params-json out_grid_round9_weekly_hybrid/best_params.json \
            --out-dir out_grid_round9_weekly_hybrid/best_full

      - name: Build dashboard + true rolling 10y stats
        run: |
          python scripts/analyze_dashboard_plus.py \
            --out-dir out_grid_round9_weekly_hybrid \
            --best-full-dir out_grid_round9_weekly_hybrid/best_full \
            --top-k 30 \
            --rank-by median_calmar

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: round9-weekly-hybrid-expanded-results
          path: |
            config/universe.yml
            config/grid_round9_weekly_hybrid_expanded.yml
            out_grid_round9_weekly_hybrid/param_summary.csv
            out_grid_round9_weekly_hybrid/best_params.json
            out_grid_round9_weekly_hybrid/wf_results.csv
            out_grid_round9_weekly_hybrid/wf_results.parquet
            out_grid_round9_weekly_hybrid/dashboard_summary.csv
            out_grid_round9_weekly_hybrid/rolling10y.csv
            out_grid_round9_weekly_hybrid/rolling10y_stats.json
            out_grid_round9_weekly_hybrid/best_full/equity.csv
            out_grid_round9_weekly_hybrid/best_full/weights.parquet
            out_grid_round9_weekly_hybrid/best_full/trades.parquet
            out_grid_round9_weekly_hybrid/best_full/signals.parquet
            out_grid_round9_weekly_hybrid/best_full/weights.csv
            out_grid_round9_weekly_hybrid/best_full/trades.csv
            out_grid_round9_weekly_hybrid/best_full/signals.csv